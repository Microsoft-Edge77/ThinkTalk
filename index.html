<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ThinkTalk Mobile - Metro</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
/* --- Design System Windows Phone (Metro) --- */
:root {
    --accent: #0078d7; /* Bleu Cobalt Windows */
    --bg: #000000;
    --fg: #ffffff;
    --subtle: #888888;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    background: var(--bg);
    color: var(--fg);
    font-family: "Segoe UI", "Open Sans", Helvetica, sans-serif;
    height: 100vh;
    overflow: hidden;
}

/* --- Structure Panorama (Coulissement) --- */
#app {
    display: flex;
    width: 300vw;
    height: 100vh;
    transition: transform 0.5s cubic-bezier(0.1, 0.7, 0.1, 1);
}

section {
    width: 100vw;
    height: 100vh;
    padding: 25px 20px 80px 20px; /* Espace pour la barre du bas */
    display: flex;
    flex-direction: column;
}

.panorama-title {
    font-size: 13px;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 2px;
    margin-bottom: 5px;
}

.section-header {
    font-size: 52px;
    font-weight: 100;
    margin-bottom: 25px;
    color: var(--accent);
    line-height: 1;
}

/* --- Tuiles Accueil --- */
.tile-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.tile {
    background: var(--accent);
    aspect-ratio: 1/1;
    padding: 12px;
    display: flex;
    align-items: flex-end;
    font-size: 16px;
    font-weight: 600;
    text-transform: lowercase;
    cursor: pointer;
    transition: transform 0.1s;
}

.tile:active { transform: scale(0.92); }
.tile.double { grid-column: span 2; aspect-ratio: 2/1; }
.tile.grey { background: #222; }

/* --- Messages Style --- */
#messages {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.msg {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { transform: translateX(20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.msg .pseudo {
    color: var(--accent);
    font-weight: bold;
    font-size: 12px;
    text-transform: uppercase;
}

.msg .text {
    font-size: 19px;
    font-weight: 300;
    line-height: 1.3;
}

/* --- Barre de saisie flottante --- */
#inputArea {
    position: fixed;
    bottom: 70px;
    left: 0;
    width: 100%;
    padding: 0 15px;
    display: flex;
    gap: 10px;
    background: var(--bg);
}

#messageInput {
    flex: 1;
    background: #fff;
    border: none;
    padding: 12px;
    font-size: 16px;
    color: #000;
}

#sendBtn {
    background: var(--accent);
    border: none;
    color: white;
    width: 50px;
    font-size: 20px;
}

/* --- Application Bar --- */
.app-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 65px;
    background: #111;
    display: flex;
    justify-content: center;
    gap: 40px;
    align-items: center;
    border-top: 1px solid #333;
    z-index: 90;
}

.nav-btn {
    width: 42px;
    height: 42px;
    border: 2px solid #fff;
    border-radius: 50%;
    background: none;
    color: #fff;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* --- Auth & Overlays --- */
#authOverlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 1000;
    padding: 40px 25px;
    display: flex;
    flex-direction: column;
}

.auth-input {
    background: #fff;
    border: none;
    padding: 15px;
    margin-bottom: 10px;
    width: 100%;
    font-size: 16px;
}

.btn-main {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 15px;
    font-weight: bold;
    font-size: 16px;
    margin-top: 10px;
}

.hidden { display: none !important; }

/* --- Listes --- */
.list-item {
    padding: 15px 0;
    border-bottom: 1px solid #222;
    font-size: 20px;
    font-weight: 100;
}
</style>
</head>
<body>

<div id="authOverlay">
    <div class="panorama-title">THINKTALK</div>
    <h1 class="section-header" style="color:#fff">bienvenue</h1>
    
    <input id="authPseudo" class="auth-input" placeholder="pseudo">
    <input id="authCode" class="auth-input" placeholder="code secret" type="password">
    
    <button class="btn-main" onclick="login()">SE CONNECTER</button>
    <button class="btn-main" style="background:#333" onclick="register()">CR√âER UN COMPTE</button>
</div>

<div id="app">
    <section id="sec-home">
        <div class="panorama-title">THINKTALK</div>
        <div class="section-header">accueil</div>
        
        <div class="tile-grid">
            <div class="tile" onclick="selectRoom('general')">#general</div>
            <div class="tile" onclick="selectRoom('gaming')">#gaming</div>
            <div class="tile" onclick="selectRoom('music')">#music</div>
            <div class="tile grey" onclick="scrollToSection(2)">contacts</div>
            <div class="tile double grey" onclick="logout()">d√©connexion</div>
        </div>
    </section>

    <section id="sec-chat">
        <div class="panorama-title">THINKTALK</div>
        <div class="section-header" id="currentContextName">salon</div>
        
        <div id="messages">
            <p style="color:var(--subtle); font-style:italic;">S√©lectionnez un salon pour discuter</p>
        </div>

        <div id="inputArea" class="hidden">
            <input id="messageInput" placeholder="r√©pondre...">
            <button id="sendBtn">‚ûî</button>
        </div>
    </section>

    <section id="sec-contacts">
        <div class="panorama-title">THINKTALK</div>
        <div class="section-header">contacts</div>
        <div id="contactsList"></div>
        <button class="btn-main" onclick="addContact()">+ AJOUTER</button>
    </section>
</div>

<div class="app-bar">
    <button class="nav-btn" onclick="scrollToSection(0)">üè†</button>
    <button class="nav-btn" onclick="scrollToSection(1)">üí¨</button>
    <button class="nav-btn" onclick="scrollToSection(2)">üë§</button>
</div>

<script>
// --- CONFIG FIREBASE (Tes cl√©s originales) ---
const firebaseConfig = {
  apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
  authDomain: "chat-github-6abb5.firebaseapp.com",
  databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-github-6abb5",
  storageBucket: "chat-github-6abb5.firebasestorage.app",
  messagingSenderId: "1038562300660",
  appId: "1:1038562300660:web:b57b74a7539466e16384a1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = localStorage.getItem("thinktalk_pseudo");
let currentContext = null;

// --- NAVIGATION ---
function scrollToSection(index) {
    document.getElementById('app').style.transform = `translateX(-${index * 100}vw)`;
}

// --- AUTHENTIFICATION ---
async function login() {
    const pseudo = document.getElementById("authPseudo").value.trim();
    const code = document.getElementById("authCode").value.trim();
    if(!pseudo || !code) return alert("Champs vides !");

    const snap = await db.ref("users/"+pseudo).get();
    if(snap.exists() && snap.val().code === code) {
        successAuth(pseudo);
    } else {
        alert("Identifiants incorrects");
    }
}

async function register() {
    const pseudo = document.getElementById("authPseudo").value.trim();
    const code = document.getElementById("authCode").value.trim();
    if(code.length < 4) return alert("Code trop court");

    const userRef = db.ref("users/"+pseudo);
    const snap = await userRef.get();
    if(snap.exists()) return alert("D√©j√† pris !");

    await userRef.set({code});
    successAuth(pseudo);
}

function successAuth(pseudo) {
    currentUser = pseudo;
    localStorage.setItem("thinktalk_pseudo", pseudo);
    document.getElementById("authOverlay").classList.add("hidden");
    loadContacts();
}

function logout() {
    localStorage.clear();
    location.reload();
}

// --- LOGIQUE CHAT ---
function selectRoom(name) {
    currentContext = {type:"room", id:name};
    document.getElementById("currentContextName").textContent = name;
    document.getElementById("inputArea").classList.remove("hidden");
    scrollToSection(1);
    listenMessages();
}

function listenMessages() {
    const path = currentContext.type === "room" ? `messages/public/${currentContext.id}` : `messages/dm/${currentContext.id}`;
    const ref = db.ref(path);
    const container = document.getElementById("messages");
    
    ref.off();
    container.innerHTML = "";
    
    ref.limitToLast(25).on("child_added", snap => {
        const m = snap.val();
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `<div class="pseudo">${m.pseudo}</div><div class="text">${m.text}</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    });
}

document.getElementById("sendBtn").onclick = () => {
    const input = document.getElementById("messageInput");
    if(!input.value.trim() || !currentContext) return;

    const path = currentContext.type === "room" ? `messages/public/${currentContext.id}` : `messages/dm/${currentContext.id}`;
    db.ref(path).push({
        pseudo: currentUser,
        text: input.value.trim(),
        timestamp: Date.now()
    });
    input.value = "";
};

// --- CONTACTS ---
async function loadContacts() {
    const list = document.getElementById("contactsList");
    list.innerHTML = "";
    const snap = await db.ref("contacts/"+currentUser).get();
    if(snap.exists()) {
        Object.keys(snap.val()).forEach(name => {
            const div = document.createElement("div");
            div.className = "list-item";
            div.textContent = name;
            div.onclick = () => {
                currentContext = {type:"dm", id:[currentUser, name].sort().join("__")};
                document.getElementById("currentContextName").textContent = name;
                document.getElementById("inputArea").classList.remove("hidden");
                scrollToSection(1);
                listenMessages();
            };
            list.appendChild(div);
        });
    }
}

async function addContact() {
    const name = prompt("Pseudo du contact :");
    if(!name || name === currentUser) return;
    const snap = await db.ref("users/"+name).get();
    if(!snap.exists()) return alert("Inconnu");
    
    await db.ref(`contacts/${currentUser}/${name}`).set(true);
    await db.ref(`contacts/${name}/${currentUser}`).set(true);
    loadContacts();
}

// Auto-login
if(currentUser) {
    document.getElementById("authOverlay").classList.add("hidden");
    loadContacts();
}
</script>

</body>
</html>
