<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ThinkTalk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --accent: #0078d7; --bg: #000; --text: #fff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; }
        body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; position: fixed; width: 100%; }
        #canvas-dust { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
        
        #auth-screen { position: fixed; inset: 0; z-index: 5000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .auth-logo { font-size: 3.5rem; font-weight: 100; color: var(--accent); margin-bottom: 40px; }
        
        .app-root { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; display: none; }
        .top-bar { padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .top-title { font-size: 2.2rem; font-weight: 100; color: var(--accent); }
        
        .view-container { flex: 1; position: relative; overflow-y: auto; padding: 10px; padding-bottom: 80px; }
        .view-section { display: none; width: 100%; }
        .view-section.active { display: block; }
        
        .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 12px; color: #fff; outline: none; }
        .btn-add { background: var(--accent); border: none; color: #fff; padding: 0 20px; font-size: 1.5rem; cursor: pointer; }
        
        .tiles-grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: 110px; gap: 12px; }
        .tile { position: relative; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; display: flex; flex-direction: column; justify-content: flex-end; cursor: pointer; backdrop-filter: blur(4px); transition: 0.3s; }
        .tile:hover { border-color: var(--accent); background: rgba(0, 120, 215, 0.1); }
        
        .btn-del-item { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.5); color: white; border: none; width: 22px; height: 22px; font-size: 12px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; border-radius: 3px; }

        #chat-messages { height: calc(100vh - 220px); overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .msg-block { align-self: flex-start; max-width: 90%; animation: materialize 0.5s ease-out forwards; }
        .msg-text { background: rgba(255,255,255,0.08); padding: 10px; border-left: 3px solid var(--accent); word-break: break-word; }
        .msg-block.own { align-self: flex-end; }
        .msg-block.own .msg-text { border-left: none; border-right: 3px solid #666; background: rgba(0,120,215,0.15); }

        .popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
        .popup-card { background: #000; border: 1px solid var(--accent); width: 100%; max-width: 300px; padding: 20px; text-align: center; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 56px; display: flex; background: #000; border-top: 1px solid #222; }
        .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.9rem; cursor: pointer; }
        .nav-btn.active { color: #fff; font-weight: bold; border-top: 2px solid var(--accent); }
        
        .input-box { width: 100%; background: #111; border: 1px solid #333; color: var(--accent); padding: 12px; margin-bottom: 10px; outline: none; }
        .btn-full { width: 100%; padding: 12px; background: var(--accent); border: none; color: #fff; margin-top: 10px; cursor: pointer; font-weight: bold; }
        
        @keyframes materialize { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<canvas id="canvas-dust"></canvas>

<div class="popup-overlay" id="global-popup">
    <div class="popup-card">
        <p id="popup-text" style="margin-bottom:20px"></p>
        <button class="btn-full" onclick="closePopup()">OK</button>
    </div>
</div>

<div id="auth-screen">
    <div class="auth-logo">thinktalk</div>
    <div style="width: 100%; max-width: 300px;">
        <input type="text" id="auth-pseudo" class="input-box" placeholder="pseudo">
        <input type="password" id="auth-code" class="input-box" placeholder="code">
        <button class="btn-full" id="btn-login">se connecter</button>
        <button class="btn-full" style="background:#222" id="btn-register">créer un compte</button>
    </div>
</div>

<div class="app-root" id="main-app">
    <div class="top-bar">
        <div class="top-title">thinktalk</div>
        <button onclick="localStorage.clear(); location.reload()" style="background:none; border:none; color:#666; cursor:pointer">déconnexion</button>
    </div>

    <div class="view-container">
        <section id="view-home" class="view-section active">
            <div class="action-row">
                <input type="text" id="new-room-input" class="search-box" placeholder="rechercher ou créer...">
                <button class="btn-add" id="btn-add-room">+</button>
            </div>
            <div class="tiles-grid" id="rooms-grid"></div>
        </section>

        <section id="view-chat" class="view-section">
            <div id="chat-header" style="color:var(--accent); margin-bottom:10px; font-weight:bold; text-transform:uppercase"># général</div>
            <div id="chat-messages"></div>
            <div style="position:fixed; bottom:56px; left:0; right:0; display:flex; background:#000; padding:10px; gap:8px;">
                <input type="text" id="chat-input" class="input-box" style="margin:0" placeholder="écrire...">
                <button id="send-btn" style="background:var(--accent); color:#fff; border:none; padding:0 20px; cursor:pointer;">OK</button>
            </div>
        </section>

        <section id="view-contacts" class="view-section">
            <div class="action-row">
                <input type="text" id="contact-name-input" class="search-box" placeholder="nom du contact...">
                <button class="btn-add" id="btn-do-add-contact">+</button>
            </div>
            <div class="tiles-grid" id="contacts-grid"></div>
        </section>
    </div>

    <nav class="bottom-nav">
        <div class="nav-btn active" id="nav-home" onclick="switchTab('home')">accueil</div>
        <div class="nav-btn" id="nav-chat" onclick="switchTab('chat')">chat</div>
        <div class="nav-btn" id="nav-contacts" onclick="switchTab('contacts')">contacts</div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyCv4nD9Nyez5ERGvW47q-6O-TA96zWJn0M", 
        authDomain: "thinktalk-b3c85.firebaseapp.com", 
        projectId: "thinktalk-b3c85", 
        storageBucket: "thinktalk-b3c85.firebasestorage.app", 
        messagingSenderId: "752141817301", 
        appId: "1:752141817301:web:28fecaf81db27eb51d595c" 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUser = localStorage.getItem('tt_user');
    let curRoom = "général";
    let unsubChat = null;
    let allRooms = [];

    window.openPopup = (text) => {
        document.getElementById('popup-text').innerText = text;
        document.getElementById('global-popup').style.display = 'flex';
    };
    window.closePopup = () => {
        document.getElementById('global-popup').style.display = 'none';
    };

    window.onload = () => {
        if(currentUser) {
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('main-app').style.display='flex';
            initRooms();
            initContacts();
            enterRoom("général");
        }
    };

    document.getElementById('btn-register').onclick = async () => {
        const p = document.getElementById('auth-pseudo').value.trim();
        const c = document.getElementById('auth-code').value.trim();
        if(!p || !c) return openPopup("Remplis tout !");
        await addDoc(collection(db, "users"), { pseudo: p, code: c });
        openPopup("Compte créé !");
    };

    document.getElementById('btn-login').onclick = async () => {
        const p = document.getElementById('auth-pseudo').value.trim();
        const c = document.getElementById('auth-code').value.trim();
        const q = query(collection(db, "users"), where("pseudo", "==", p), where("code", "==", c));
        const res = await getDocs(q);
        if(!res.empty) {
            localStorage.setItem('tt_user', p);
            location.reload();
        } else openPopup("Identifiants incorrects.");
    };

    function initRooms() {
        onSnapshot(collection(db, "rooms"), (snap) => {
            allRooms = [];
            snap.forEach(d => allRooms.push({id: d.id, ...d.data()}));
            renderRooms(allRooms);
        });
    }

    function renderRooms(rooms) {
        const grid = document.getElementById('rooms-grid');
        grid.innerHTML = "";
        rooms.forEach(r => {
            const tile = document.createElement('div');
            tile.className = "tile";
            tile.innerHTML = `<span># ${r.name}</span>`;
            tile.onclick = () => { enterRoom(r.name); switchTab('chat'); };
            grid.appendChild(tile);
        });
    }

    document.getElementById('new-room-input').oninput = (e) => {
        const search = e.target.value.toLowerCase();
        const filtered = allRooms.filter(r => r.name.toLowerCase().includes(search));
        renderRooms(filtered);
    };

    document.getElementById('btn-add-room').onclick = async () => {
        const input = document.getElementById('new-room-input');
        if(input.value.trim()) {
            await addDoc(collection(db, "rooms"), { name: input.value.trim(), creator: currentUser });
            input.value = "";
        }
    };

    // --- SECTION CONTACTS CORRIGÉE ---
    function initContacts() {
        // Suppression du orderBy pour éviter de forcer un index composite
        const q = query(collection(db, "contacts"), where("owner", "==", currentUser));
        
        onSnapshot(q, (snap) => {
            const contactGrid = document.getElementById('contacts-grid');
            contactGrid.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const tile = document.createElement('div');
                tile.className = "tile";
                tile.style.border = "1px solid var(--accent)";
                tile.innerHTML = `
                    <button class="btn-del-item" onclick="deleteItem('contacts', '${d.id}', event)">X</button>
                    <span style="font-weight:bold; color:var(--accent)">@ ${c.name}</span>
                `;
                tile.onclick = () => { enterRoom(c.name); switchTab('chat'); };
                contactGrid.appendChild(tile);
            });
        }, (error) => {
            console.error("Erreur contacts:", error);
            if(error.code === 'failed-precondition') {
                openPopup("Index Firestore manquant. Vérifie la console F12.");
            }
        });
    }

    document.getElementById('btn-do-add-contact').onclick = async () => {
        const input = document.getElementById('contact-name-input');
        const val = input.value.trim();
        if(val && currentUser) {
            try {
                await addDoc(collection(db, "contacts"), { 
                    name: val, 
                    owner: currentUser, 
                    timestamp: serverTimestamp() 
                });
                input.value = "";
                openPopup("Contact ajouté !");
            } catch (e) {
                console.error("Erreur ajout:", e);
                openPopup("Erreur d'enregistrement.");
            }
        } else {
            openPopup("Nom vide !");
        }
    };

    window.enterRoom = (name) => {
        curRoom = name;
        document.getElementById('chat-header').innerText = "# " + name;
        if(unsubChat) unsubChat();
        const q = query(collection(db, "messages"), where("room", "==", name), orderBy("timestamp", "asc"));
        unsubChat = onSnapshot(q, (snap) => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = "msg-block" + (m.sender === currentUser ? " own" : "");
                div.innerHTML = `<div style="font-size:9px; opacity:0.5">${m.sender}</div><div class="msg-text">${m.text}</div>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    document.getElementById('send-btn').onclick = async () => {
        const i = document.getElementById('chat-input');
        if(i.value.trim()) {
            await addDoc(collection(db, "messages"), { 
                text: i.value, room: curRoom, sender: currentUser, timestamp: serverTimestamp() 
            });
            i.value = "";
        }
    };

    window.deleteItem = async (col, id, e) => {
        e.stopPropagation();
        try {
            await deleteDoc(doc(db, col, id));
            openPopup("Supprimé");
        } catch (err) {
            openPopup("Erreur suppression");
        }
    };

    window.switchTab = (t) => {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
        document.getElementById('nav-'+t).classList.add('active');
    };

    // Dust Effect logic (Inchangé)
    const canvas = document.getElementById('canvas-dust'), ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();
    class P {
        constructor() { this.x = Math.random()*canvas.width; this.y = Math.random()*canvas.height; this.vx = Math.random()-0.5; this.vy = Math.random()-0.5; }
        draw() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>canvas.width)this.vx*=-1; if(this.y<0||this.y>canvas.height)this.vy*=-1; ctx.fillStyle="rgba(0,120,215,0.3)"; ctx.fillRect(this.x,this.y,2,2); }
    }
    for(let i=0; i<50; i++) particles.push(new P());
    function loop() { ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>p.draw()); requestAnimationFrame(loop); } loop();
</script>
</body>
</html>
