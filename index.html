<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ThinkTalk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root { --accent: #0078d7; --bg: #000; --text: #fff; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; }
    body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; position: fixed; width: 100%; }

    #canvas-dust { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
    .app-root { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; }

    .top-bar { padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
    .top-title { font-size: 2.2rem; font-weight: 100; color: var(--accent); }
    .hamburger { font-size: 28px; cursor: pointer; padding: 5px; color: #fff; }

    .view-container { flex: 1; position: relative; overflow-y: auto; padding: 10px; padding-bottom: 80px; }
    .view-section { display: none; width: 100%; }
    .view-section.active { display: block; }

    .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .search-box { flex: 1; background: #000; border: 1px solid #333; padding: 10px; color: #fff; border-radius: 0; outline: none; }
    .search-box:focus { border-color: var(--accent); }
    .btn-add { background: var(--accent); border: none; color: #fff; padding: 0 20px; font-size: 1.5rem; cursor: pointer; }

    .tiles-grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: 110px; gap: 12px; transition: 0.5s; }
    .tile { 
        background: rgba(20, 20, 20, 0.85); border: 1px solid rgba(255,255,255,0.1); 
        padding: 15px; display: flex; flex-direction: column; justify-content: flex-end;
        transition: transform 0.4s, opacity 0.4s; cursor: pointer; 
    }
    .tile-1x1 { grid-column: span 1; grid-row: span 1; }
    .tile-2x1 { grid-column: span 2; grid-row: span 1; }
    .tile-2x2 { grid-column: span 2; grid-row: span 2; }

    #chat-messages { height: calc(100vh - 220px); overflow-y: auto; padding: 10px; }
    .msg-block { margin-bottom: 12px; animation: materialize 0.6s forwards; }
    .msg-text { background: rgba(255,255,255,0.05); padding: 10px; border-left: 3px solid var(--accent); }
    
    .input-bar { position: fixed; bottom: 56px; left: 0; right: 0; display: flex; background: #000; padding: 10px; gap: 8px; border-top: 1px solid #222; }
    .input-box { flex: 1; background: #111; border: 1px solid #333; color: var(--accent); padding: 10px; outline: none; }

    .popup-overlay { 
        position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; 
        display: none; align-items: center; justify-content: center; padding: 20px;
        backdrop-filter: blur(10px);
    }
    .popup-card { 
        background: #000; border: 1px solid var(--accent); width: 100%; max-width: 300px; padding: 20px;
        animation: materialize 0.5s forwards;
    }
    @keyframes materialize { from { filter: blur(15px); opacity: 0; transform: scale(0.9); } to { filter: blur(0); opacity: 1; transform: scale(1); } }

    .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 56px; display: flex; background: #000; border-top: 1px solid #222; }
    .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.9rem; cursor: pointer; }
    .nav-btn.active { color: #fff; font-weight: bold; border-top: 2px solid var(--accent); }

    .btn-full { width: 100%; padding: 12px; background: var(--accent); border: none; color: #fff; margin-top: 10px; cursor: pointer; }
    .btn-red { background: #cc0000; }
  </style>
</head>
<body>

<canvas id="canvas-dust"></canvas>

<div class="popup-overlay" id="pop-create">
    <div class="popup-card">
        <h3>nouveau salon</h3>
        <input type="text" id="new-room-name" placeholder="nom..." class="input-box" style="margin-bottom:10px">
        <input type="text" id="new-room-code" placeholder="code (optionnel)..." class="input-box">
        <button class="btn-full" id="btn-confirm-create">crÃ©er</button>
        <button class="btn-full" style="background:#333" onclick="closePopups()">annuler</button>
    </div>
</div>

<div class="popup-overlay" id="pop-menu">
    <div class="popup-card">
        <h3 style="color:var(--accent)">menu</h3>
        <button class="btn-full btn-red" id="btn-logout">dÃ©connexion</button>
        <button class="btn-full" style="background:#333" onclick="closePopups()">fermer</button>
    </div>
</div>

<div class="app-root">
    <div class="top-bar">
        <div id="top-label" class="top-title">thinktalk</div>
        <div class="hamburger" onclick="openMenu()">â˜°</div>
    </div>

    <div class="view-container">
        <section id="view-home" class="view-section active">
            <div class="action-row">
                <input type="text" class="search-box" placeholder="rechercher...">
                <button class="btn-add" onclick="openCreatePop()">+</button>
            </div>
            <div class="tiles-grid" id="rooms-grid"></div>
        </section>

        <section id="view-chat" class="view-section">
            <div id="chat-header" style="color:var(--accent); margin-bottom:10px; font-weight:bold"></div>
            <div id="chat-messages"></div>
            <div class="input-bar">
                <button style="background:none; border:none; color:var(--accent); font-size:20px">ðŸ“Ž</button>
                <input type="text" id="chat-input" class="input-box" placeholder="rÃ©pondre...">
                <button id="send-btn" style="background:var(--accent); color:#fff; border:none; padding:10px 15px">OK</button>
            </div>
        </section>

        <section id="view-contacts" class="view-section">
            <div class="action-row">
                <input type="text" id="contact-name-input" class="search-box" placeholder="nom du contact...">
                <button class="btn-add" id="btn-add-contact">+</button>
            </div>
            <div class="tiles-grid" id="contacts-grid"></div>
        </section>
    </div>

    <nav class="bottom-nav">
        <div class="nav-btn active" onclick="switchTab('home')">accueil</div>
        <div class="nav-btn" onclick="switchTab('chat')">chat</div>
        <div class="nav-btn" onclick="switchTab('contacts')">contacts</div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCv4nD9Nyez5ERGvW47q-6O-TA96zWJn0M",
        authDomain: "thinktalk-b3c85.firebaseapp.com",
        projectId: "thinktalk-b3c85",
        storageBucket: "thinktalk-b3c85.firebasestorage.app",
        messagingSenderId: "752141817301",
        appId: "1:752141817301:web:28fecaf81db27eb51d595c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DUST ENGINE
    const canvas = document.getElementById('canvas-dust');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();
    class P { constructor(){this.r()} r(){this.x=Math.random()*canvas.width;this.y=Math.random()*canvas.height;this.v=(Math.random()-0.5)*0.3;this.s=Math.random()*1.5} u(){this.x+=this.v;this.y+=this.v;if(this.x<0||this.x>canvas.width)this.r()} d(){ctx.fillStyle="rgba(0,120,215,0.25)";ctx.beginPath();ctx.arc(this.x,this.y,this.s,0,7);ctx.fill()}}
    for(let i=0;i<60;i++)particles.push(new P());
    function anim(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{p.u();p.d()}); requestAnimationFrame(anim) } anim();

    // NAVIGATION (GLOBAL SCOPE)
    window.switchTab = (t) => {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-'+t).classList.add('active');
        document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
        document.getElementById('top-label').style.display = (t==='home') ? 'block' : 'none';
    };

    window.openCreatePop = () => document.getElementById('pop-create').style.display = 'flex';
    window.openMenu = () => document.getElementById('pop-menu').style.display = 'flex';
    window.closePopups = () => document.querySelectorAll('.popup-overlay').forEach(p=>p.style.display='none');

    // FIRESTORE : ROOMS
    onSnapshot(collection(db, "rooms"), (snap) => {
        const grid = document.getElementById('rooms-grid');
        grid.innerHTML = "";
        let i = 0;
        snap.forEach(doc => {
            const r = doc.data();
            const tile = document.createElement('div');
            const sizes = ['tile-1x1', 'tile-2x1', 'tile-2x2'];
            tile.className = `tile ${sizes[i % 3]}`;
            tile.innerHTML = `<span># ${r.name}</span>`;
            tile.onclick = () => joinRoom(r.name, r.code);
            grid.appendChild(tile);
            i++;
        });
    });

    document.getElementById('btn-confirm-create').onclick = async () => {
        const name = document.getElementById('new-room-name').value.trim();
        const code = document.getElementById('new-room-code').value.trim();
        if(!name) return;

        // VÃ©rification UnicitÃ©
        const q = query(collection(db, "rooms"), where("name", "==", name));
        const check = await getDocs(q);
        if(!check.empty) return alert("Ce nom existe dÃ©jÃ  !");

        await addDoc(collection(db, "rooms"), { name, code: code || null, createdAt: serverTimestamp() });
        document.getElementById('new-room-name').value = "";
        document.getElementById('new-room-code').value = "";
        closePopups();
    };

    // FIRESTORE : CONTACTS
    onSnapshot(collection(db, "contacts"), (snap) => {
        const grid = document.getElementById('contacts-grid');
        grid.innerHTML = "";
        snap.forEach(doc => {
            const c = doc.data();
            grid.innerHTML += `<div class="tile tile-1x1"><span>@ ${c.name}</span></div>`;
        });
    });

    document.getElementById('btn-add-contact').onclick = async () => {
        const name = document.getElementById('contact-name-input').value.trim();
        if(name) await addDoc(collection(db, "contacts"), { name });
        document.getElementById('contact-name-input').value = "";
    };

    // CHAT ENGINE
    let curRoom = "";
    let unsubChat = null;
    function joinRoom(name, code) {
        if(code) {
            const pass = prompt("Code requis :");
            if(pass !== code) return alert("Code incorrect");
        }
        curRoom = name;
        document.getElementById('chat-header').innerText = "# " + name;
        switchTab('chat');
        if(unsubChat) unsubChat();
        const q = query(collection(db, "messages"), where("room", "==", name), orderBy("timestamp", "asc"));
        unsubChat = onSnapshot(q, (snap) => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const time = m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
                box.innerHTML += `
                    <div class="msg-block">
                        <div style="display:flex; justify-content:space-between; font-size:10px; color:var(--accent); margin-bottom:4px;">
                            <span>MOI</span><span>${time}</span>
                        </div>
                        <div class="msg-text">${m.text}</div>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    document.getElementById('send-btn').onclick = async () => {
        const input = document.getElementById('chat-input');
        if(input.value.trim() && curRoom) {
            await addDoc(collection(db, "messages"), { 
                text: input.value, 
                room: curRoom, 
                timestamp: serverTimestamp() 
            });
            input.value = "";
        }
    };

    document.getElementById('btn-logout').onclick = () => { location.reload(); };

</script>
</body>
</html>
