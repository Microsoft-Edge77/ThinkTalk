<!DOCTYPE html>
<html lang="fr">
<head>
Â  <meta charset="UTF-8">
Â  <title>ThinkTalk</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  <style>
Â  Â  :root { --accent: #0078d7; --bg: #000; --text: #fff; }
Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; }
Â  Â  body { background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; position: fixed; width: 100%; }
Â  Â  #canvas-dust { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
Â  Â  #auth-screen { position: fixed; inset: 0; z-index: 5000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
Â  Â  .auth-logo { font-size: 3.5rem; font-weight: 100; color: var(--accent); margin-bottom: 40px; }
Â  Â  .app-root { position: relative; z-index: 1; height: 100vh; display: flex; flex-direction: column; display: none; }
Â  Â  .top-bar { padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
Â  Â  .top-title { font-size: 2.2rem; font-weight: 100; color: var(--accent); }
Â  Â  .hamburger { font-size: 28px; cursor: pointer; color: #fff; position: relative; }
    
    /* Menu dÃ©roulant style Metro */
    .dropdown-menu { display: none; position: absolute; top: 100%; right: 0; background: #000; border: 1px solid var(--accent); width: 200px; z-index: 1000; animation: materialize 0.3s forwards; }
    .dropdown-item { padding: 12px; color: #fff; cursor: pointer; border-bottom: 1px solid #222; font-size: 0.9rem; }
    .dropdown-item:hover { background: var(--accent); }

Â  Â  .view-container { flex: 1; position: relative; overflow-y: auto; padding: 10px; padding-bottom: 80px; }
Â  Â  .view-section { display: none; width: 100%; }
Â  Â  .view-section.active { display: block; }
Â  Â  .action-row { display: flex; gap: 10px; margin-bottom: 15px; }
Â  Â  .search-box { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 12px; color: #fff; outline: none; }
Â  Â  .btn-add { background: var(--accent); border: none; color: #fff; padding: 0 20px; font-size: 1.5rem; cursor: pointer; }
Â  Â  .tiles-grid { display: grid; grid-template-columns: repeat(2, 1fr); grid-auto-rows: 110px; gap: 12px; }
Â  Â  .tile { position: relative; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; display: flex; flex-direction: column; justify-content: flex-end; cursor: pointer; backdrop-filter: blur(4px); }
Â  Â  .tile-1x1 { grid-column: span 1; grid-row: span 1; }
    .btn-del-tile { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.3); color: white; border: none; padding: 2px 6px; font-size: 12px; cursor: pointer; z-index: 2; }
Â  Â  #chat-messages { height: calc(100vh - 220px); overflow-y: auto; padding: 10px; }
Â  Â  .msg-block { margin-bottom: 12px; animation: materialize 0.6s forwards; cursor: pointer; -webkit-user-select: none; user-select: none; }
Â  Â  .msg-text { background: rgba(255,255,255,0.08); padding: 10px; border-left: 3px solid var(--accent); word-break: break-word; }
Â  Â  .msg-img { max-width: 100%; border-radius: 4px; margin-top: 5px; border: 1px solid #333; }
Â  Â  .popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
Â  Â  .popup-card { background: #000; border: 1px solid var(--accent); width: 100%; max-width: 300px; padding: 20px; animation: materialize 0.5s forwards; }
Â  Â  @keyframes materialize { from { filter: blur(15px); opacity: 0; transform: scale(0.9); } to { filter: blur(0); opacity: 1; transform: scale(1); } }
Â  Â  .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 56px; display: flex; background: #000; border-top: 1px solid #222; }
Â  Â  .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; color: #666; font-size: 0.9rem; cursor: pointer; }
Â  Â  .nav-btn.active { color: #fff; font-weight: bold; border-top: 2px solid var(--accent); }
Â  Â  .input-box { width: 100%; background: #111; border: 1px solid #333; color: var(--accent); padding: 12px; margin-bottom: 10px; outline: none; }
Â  Â  .btn-full { width: 100%; padding: 12px; background: var(--accent); border: none; color: #fff; margin-top: 10px; cursor: pointer; font-weight: bold; }
Â  Â  .btn-secondary { background: #222; border: 1px solid #444; }
Â  </style>
</head>
<body>
<canvas id="canvas-dust"></canvas>

<input type="file" id="file-input" accept="image/*" style="display:none">

<div class="popup-overlay" id="pop-alert"><div class="popup-card"><p id="alert-text"></p><button class="btn-full" onclick="closePopups()">ok</button></div></div>
<div class="popup-overlay" id="pop-create"><div class="popup-card"><h3>nouveau salon</h3><input type="text" id="new-room-name" placeholder="nom..." class="input-box"><button class="btn-full" id="btn-confirm-create">crÃ©er</button></div></div>

<div class="popup-overlay" id="pop-msg-options">
    <div class="popup-card">
        <h3 style="color:var(--accent); margin-bottom:15px">option message</h3>
        <button class="btn-full" id="btn-msg-edit">Ã©diter</button>
        <button class="btn-full" id="btn-msg-del" style="background:#a30000">supprimer</button>
        <button class="btn-full btn-secondary" onclick="closePopups()">retour</button>
    </div>
</div>

<div class="popup-overlay" id="pop-del-account">
    <div class="popup-card">
        <h3 style="color:#a30000; margin-bottom:15px">sÃ©curitÃ©</h3>
        <p style="margin-bottom:10px; font-size:0.9rem">entrez votre code pour confirmer la suppression dÃ©finitive :</p>
        <input type="password" id="confirm-del-code" class="input-box" placeholder="votre code">
        <button class="btn-full" id="btn-final-delete" style="background:#a30000">supprimer mon compte</button>
        <button class="btn-full btn-secondary" onclick="closePopups()">annuler</button>
    </div>
</div>

<div id="auth-screen">
Â  Â  <div class="auth-logo">thinktalk</div>
Â  Â  <div style="width: 100%; max-width: 300px;">
Â  Â  Â  Â  <input type="text" id="auth-pseudo" class="input-box" placeholder="pseudo">
Â  Â  Â  Â  <input type="password" id="auth-code" class="input-box" placeholder="code">
Â  Â  Â  Â  <button class="btn-full" id="btn-login">se connecter</button>
Â  Â  Â  Â  <button class="btn-full btn-secondary" id="btn-register">crÃ©er un compte</button>
Â  Â  </div>
</div>

<div class="app-root" id="main-app">
Â  Â  <div class="top-bar">
        <div id="top-label" class="top-title">thinktalk</div>
        <div class="hamburger" id="hamburger-btn">âœ•
            <div class="dropdown-menu" id="nav-dropdown">
                <div class="dropdown-item" onclick="logout()">dÃ©connexion</div>
                <div class="dropdown-item" style="color:#ff4444" id="menu-del-account">supprimer mon compte</div>
            </div>
        </div>
    </div>
Â  Â  <div class="view-container">
Â  Â  Â  Â  <section id="view-home" class="view-section active">
Â  Â  Â  Â  Â  Â  <div class="action-row"><input type="text" class="search-box" placeholder="rechercher..."><button class="btn-add" onclick="document.getElementById('pop-create').style.display='flex'">+</button></div>
Â  Â  Â  Â  Â  Â  <div class="tiles-grid" id="rooms-grid"></div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section id="view-chat" class="view-section">
Â  Â  Â  Â  Â  Â  <div id="chat-header" style="color:var(--accent); margin-bottom:10px; font-weight:bold"># gÃ©nÃ©ral</div>
Â  Â  Â  Â  Â  Â  <div id="chat-messages"></div>
Â  Â  Â  Â  Â  Â  <div style="position:fixed; bottom:56px; left:0; right:0; display:flex; background:#000; padding:10px; gap:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="attach-btn" style="background:none; border:none; color:var(--accent); font-size:20px; cursor:pointer;">ðŸ“Ž</button>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="chat-input" class="input-box" style="margin:0" placeholder="rÃ©pondre...">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="send-btn" style="background:var(--accent); color:#fff; border:none; padding:10px 15px; cursor:pointer;">OK</button>
Â  Â  Â  0 </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section id="view-contacts" class="view-section">
Â  Â  Â  Â  Â  Â  <div class="action-row"><input type="text" id="contact-name-input" class="search-box" placeholder="nom..."><button class="btn-add" id="add-contact-now">+</button></div>
Â  Â  Â  Â  Â  Â  <div class="tiles-grid" id="contacts-grid"></div>
Â  Â  Â  Â  </section>
Â  Â  </div>
Â  Â  <nav class="bottom-nav">
Â  Â  Â  Â  <div class="nav-btn active" onclick="switchTab('home')">accueil</div>
Â  Â  Â  Â  <div class="nav-btn" onclick="switchTab('chat')">chat</div>
Â  Â  Â  Â  <div class="nav-btn" onclick="switchTab('contacts')">contacts</div>
Â  Â  </nav>
</div>

<script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
Â  Â  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

Â  Â  const firebaseConfig = { apiKey: "AIzaSyCv4nD9Nyez5ERGvW47q-6O-TA96zWJn0M", authDomain: "thinktalk-b3c85.firebaseapp.com", projectId: "thinktalk-b3c85", storageBucket: "thinktalk-b3c85.firebasestorage.app", messagingSenderId: "752141817301", appId: "1:752141817301:web:28fecaf81db27eb51d595c" };
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getFirestore(app);
Â  Â  let currentUser = null, curRoom = "gÃ©nÃ©ral", unsubChat = null, selectedMsgId = null;

Â  Â  // DUST EFFECT
Â  Â  const canvas = document.getElementById('canvas-dust'), ctx = canvas.getContext('2d');
Â  Â  let particles = [];
Â  Â  function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
Â  Â  window.onresize = resize; resize();
Â  Â  class P { constructor(){this.r()} r(){this.x=Math.random()*canvas.width;this.y=Math.random()*canvas.height;this.vx=(Math.random()-0.5)*3;this.vy=(Math.random()-0.5)*3;this.s=Math.random()*2} u(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>canvas.width||this.y<0||this.y>canvas.height)this.r()} d(){ctx.fillStyle="rgba(0,120,215,0.4)";ctx.beginPath();ctx.arc(this.x,this.y,this.s,0,7);ctx.fill()}}
Â  Â  for(let i=0;i<80;i++)particles.push(new P());
Â  Â  function anim(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{p.u();p.d()}); requestAnimationFrame(anim) } anim();

Â  Â  window.showPopupAlert = (msg) => { document.getElementById('alert-text').innerText = msg; document.getElementById('pop-alert').style.display = 'flex'; };
Â  Â  window.closePopups = () => {
        document.querySelectorAll('.popup-overlay').forEach(p=>p.style.display='none');
        document.getElementById('nav-dropdown').style.display='none';
    };

Â  Â  // PERSISTANCE CONNEXION
Â  Â  window.onload = () => {
        const savedUser = localStorage.getItem('tt_user');
        if(savedUser) {
            currentUser = savedUser;
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('main-app').style.display='flex';
            initContacts();
        }
    };

    window.logout = () => { localStorage.removeItem('tt_user'); location.reload(); };

    // Gestion Menu Hamburger
    document.getElementById('hamburger-btn').onclick = (e) => {
        const drop = document.getElementById('nav-dropdown');
        drop.style.display = (drop.style.display === 'block') ? 'none' : 'block';
        e.stopPropagation();
    };
    window.onclick = () => document.getElementById('nav-dropdown').style.display='none';

Â  Â  // AUTH
Â  Â  document.getElementById('btn-register').onclick = async () => {
Â  Â  Â  Â  const p = document.getElementById('auth-pseudo').value;
Â  Â  Â  Â  if(p) { await addDoc(collection(db, "users"), { pseudo: p, code: document.getElementById('auth-code').value }); showPopupAlert("Compte prÃªt !"); }
Â  Â  };
Â  Â  document.getElementById('btn-login').onclick = async () => {
Â  Â  Â  Â  const p = document.getElementById('auth-pseudo').value, c = document.getElementById('auth-code').value;
Â  Â  Â  Â  const q = query(collection(db, "users"), where("pseudo", "==", p), where("code", "==", c));
Â  Â  Â  Â  const res = await getDocs(q);
Â  Â  Â  Â  if(!res.empty) { 
            currentUser = p; 
            localStorage.setItem('tt_user', p);
            document.getElementById('auth-screen').style.display='none'; 
            document.getElementById('main-app').style.display='flex'; 
            initContacts();
        }
Â  Â  Â  Â  else showPopupAlert("Erreur");
Â  Â  };

    // SUPPRESSION COMPTE (LOGIQUE)
    document.getElementById('menu-del-account').onclick = () => {
        if(confirm("Ãªtes vous sÃ»r de quitter ThinkTalk ?")) {
            document.getElementById('pop-del-account').style.display='flex';
        }
    };

    document.getElementById('btn-final-delete').onclick = async () => {
        const codeInput = document.getElementById('confirm-del-code').value;
        const q = query(collection(db, "users"), where("pseudo", "==", currentUser), where("code", "==", codeInput));
        const res = await getDocs(q);
        
        if(!res.empty) {
            // Suppression de l'utilisateur
            res.forEach(async (uDoc) => { await deleteDoc(doc(db, "users", uDoc.id)); });
            // Suppression des contacts de l'utilisateur
            const qC = query(collection(db, "contacts"), where("owner", "==", currentUser));
            const snapC = await getDocs(qC);
            snapC.forEach(async (cDoc) => { await deleteDoc(doc(db, "contacts", cDoc.id)); });
            
            showPopupAlert("compte supprimÃ©. au revoir.");
            setTimeout(() => logout(), 2000);
        } else {
            showPopupAlert("code incorrect.");
        }
    };

Â  Â  // NAV & ROOMS
Â  Â  window.switchTab = (t) => {
Â  Â  Â  Â  document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
Â  Â  Â  Â  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  document.getElementById('view-'+t).classList.add('active');
Â  Â  Â  Â  const activeBtn = document.querySelector(`[onclick="switchTab('${t}')"]`);
Â  Â  Â  Â  if(activeBtn) activeBtn.classList.add('active');
Â  Â  };

Â  Â  onSnapshot(collection(db, "rooms"), (snap) => {
Â  Â  Â  Â  const grid = document.getElementById('rooms-grid'); grid.innerHTML = "";
Â  Â  Â  Â  snap.forEach(doc => {
Â  Â  Â  Â  Â  Â  const tile = document.createElement('div'); tile.className = "tile tile-1x1"; tile.innerHTML = `<span># ${doc.data().name}</span>`;
Â  Â  Â  Â  Â  Â  tile.onclick = () => enterRoom(doc.data().name); grid.appendChild(tile);
Â  Â  Â  Â  });
Â  Â  });

Â  Â  document.getElementById('btn-confirm-create').onclick = async () => {
Â  Â  Â  Â  const n = document.getElementById('new-room-name').value;
Â  Â  Â  Â  if(n) { await addDoc(collection(db, "rooms"), { name: n }); closePopups(); }
Â  Â  };

Â  Â  // CHAT ENGINE
Â  Â  window.enterRoom = (name) => {
Â  Â  Â  Â  curRoom = name; document.getElementById('chat-header').innerText = "# " + name; switchTab('chat');
Â  Â  Â  Â  if(unsubChat) unsubChat();
Â  Â  Â  Â  const q = query(collection(db, "messages"), where("room", "==", name), orderBy("timestamp", "asc"));
Â  Â  Â  Â  unsubChat = onSnapshot(q, (snap) => {
Â  Â  Â  Â  Â  Â  const box = document.getElementById('chat-messages'); box.innerHTML = "";
Â  Â  Â  Â  Â  Â  snap.forEach(d => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const m = d.data();
Â  Â  Â  Â  Â  Â  Â  Â  const isImg = m.text.startsWith("data:image");
Â  Â  Â  Â  Â  Â  Â  Â  const content = isImg ? `<img src="${m.text}" class="msg-img">` : m.text;
                const div = document.createElement('div');
                div.className = "msg-block";
                div.innerHTML = `<div style="font-size:10px; color:var(--accent)">${m.sender}</div><div class="msg-text">${content}</div>`;
                
                if(m.sender === currentUser) {
                    let timer;
                    div.onmousedown = div.ontouchstart = () => timer = setTimeout(() => { selectedMsgId = d.id; document.getElementById('pop-msg-options').style.display='flex'; }, 700);
                    div.onmouseup = div.onmouseleave = div.ontouchend = () => clearTimeout(timer);
                }
Â  Â  Â  Â  Â  Â  Â  Â  box.appendChild(div);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  box.scrollTop = box.scrollHeight;
Â  Â  Â  Â  });
Â  Â  };

    document.getElementById('btn-msg-del').onclick = async () => { if(selectedMsgId) { await deleteDoc(doc(db, "messages", selectedMsgId)); closePopups(); } };
    document.getElementById('btn-msg-edit').onclick = async () => {
        const nVal = prompt("Modifier le message :");
        if(nVal && selectedMsgId) { await updateDoc(doc(db, "messages", selectedMsgId), { text: nVal }); closePopups(); }
    };

Â  Â  const sendMessage = async (val) => {
Â  Â  Â  Â  if(val && currentUser) {
            if(val.startsWith("data:image")) {
                const img = new Image(); img.src = val;
                img.onload = async () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const maxW = 400; const scale = maxW / img.width; canvas.width = maxW; canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    await addDoc(collection(db, "messages"), { text: canvas.toDataURL("image/jpeg", 0.7), room: curRoom, sender: currentUser, timestamp: serverTimestamp() });
                };
            } else {
Â  Â  Â  Â  Â  Â      await addDoc(collection(db, "messages"), { text: val, room: curRoom, sender: currentUser, timestamp: serverTimestamp() });
            }
Â  Â  Â  Â  }
Â  Â  };

Â  Â  document.getElementById('send-btn').onclick = () => { const inp = document.getElementById('chat-input'); sendMessage(inp.value); inp.value = ""; };
Â  Â  document.getElementById('attach-btn').onclick = () => document.getElementById('file-input').click();
Â  Â  document.getElementById('file-input').onchange = (e) => { const reader = new FileReader(); reader.onload = (ev) => sendMessage(ev.target.result); reader.readAsDataURL(e.target.files[0]); };

Â  Â  // CONTACTS
    function initContacts() {
        onSnapshot(query(collection(db, "contacts"), where("owner", "==", currentUser)), (snap) => {
            const grid = document.getElementById('contacts-grid'); grid.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const tile = document.createElement('div'); tile.className = "tile tile-1x1";
                tile.innerHTML = `<button class="btn-del-tile" onclick="event.stopPropagation(); window.delContact('${d.id}')">âœ•</button><span>@ ${c.name}</span>`;
                tile.onclick = () => enterRoom(c.name); grid.appendChild(tile);
            });
        });
    }

    window.delContact = async (id) => { if(confirm("Supprimer ce contact ?")) await deleteDoc(doc(db, "contacts", id)); };

Â  Â  document.getElementById('add-contact-now').onclick = async () => {
Â  Â  Â  Â  const n = document.getElementById('contact-name-input').value;
        const q = query(collection(db, "users"), where("pseudo", "==", n));
        const res = await getDocs(q);
Â  Â  Â  Â  if(!res.empty && n !== currentUser) { 
            await addDoc(collection(db, "contacts"), { name: n, owner: currentUser }); 
            document.getElementById('contact-name-input').value = ""; 
        } else { showPopupAlert("Utilisateur introuvable ou invalide"); }
Â  Â  };
</script>
</body>
</html>
