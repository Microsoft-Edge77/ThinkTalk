<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ThinkTalk Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{
  font-family:system-ui,Arial;
  background:radial-gradient(circle at top,#051933 0,#000 55%,#000 100%);
  color:#d0e7ff;
  display:flex;
  justify-content:center;
  align-items:stretch;
}

/* CONTAINER PRINCIPAL */
#app{
  position:relative;
  width:100%;
  max-width:480px;
  height:100vh;
  background:radial-gradient(circle at top left,rgba(0,153,255,.25),rgba(0,0,0,.95));
  border-left:1px solid rgba(0,153,255,.6);
  border-right:1px solid rgba(0,153,255,.6);
  box-shadow:0 0 30px rgba(0,153,255,.7),0 0 80px rgba(0,0,0,.9);
  overflow:hidden;
}

/* HEADER */
#topBar{
  height:52px;
  padding:0 14px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-bottom:1px solid rgba(0,153,255,.5);
  background:linear-gradient(135deg,rgba(0,0,0,.9),rgba(0,51,102,.9));
}
#appName{
  font-size:18px;
  color:#7fc4ff;
  text-shadow:0 0 10px rgba(0,153,255,.8);
}

/* ZONE PRINCIPALE */
#main{
  position:absolute;
  top:52px;
  left:0;
  right:0;
  bottom:56px;
  overflow-y:auto;
  padding:10px;
}

/* LISTE HOME (salons + contacts) */
.homeItem{
  padding:10px 12px;
  margin-bottom:8px;
  border-radius:10px;
  border:1px solid rgba(0,153,255,.5);
  background:linear-gradient(135deg,rgba(0,102,204,.15),rgba(0,0,0,.8));
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:15px;
  color:#e5f2ff;
  cursor:pointer;
  transition:.15s;
}
.homeItem:hover{
  background:linear-gradient(135deg,rgba(0,153,255,.3),rgba(0,0,0,.95));
  transform:translateY(-1px);
  box-shadow:0 0 10px rgba(0,153,255,.5);
}
.badge{
  min-width:22px;
  padding:3px 6px;
  border-radius:999px;
  background:#ff3b3b;
  color:white;
  font-size:12px;
  text-align:center;
}

/* MESSAGES */
.msg{
  margin-bottom:6px;
  padding:6px 8px;
  border-radius:9px;
  background:linear-gradient(135deg,rgba(0,0,0,.9),rgba(0,153,255,.18));
  border-left:3px solid rgba(0,153,255,.8);
  animation:msgIn .18s ease-out;
}
@keyframes msgIn{
  from{transform:translateY(4px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.msg-header{
  display:flex;
  justify-content:space-between;
  font-size:11px;
  margin-bottom:2px;
}
.pseudo{
  font-weight:600;
  color:#7fc4ff;
  text-shadow:0 0 6px rgba(0,153,255,.8);
}
.time{
  color:#9fb7ff;
  opacity:.8;
  margin-left:6px;
}
.text{
  font-size:14px;
  color:#e5f2ff;
  white-space:pre-wrap;
}

/* BARRE D‚ÄôENTR√âE */
#inputBar{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:56px;
  width:100%;
  max-width:480px;
  padding:6px 8px;
  background:linear-gradient(180deg,rgba(0,0,0,.95),rgba(0,0,0,.98));
  border-top:1px solid rgba(0,153,255,.5);
  display:flex;
  gap:6px;
  z-index:15;
}
#messageInput{
  flex:1;
  padding:9px 11px;
  border-radius:999px;
  border:1px solid rgba(0,153,255,.7);
  background:rgba(0,0,0,.9);
  color:#e5f2ff;
  font-size:14px;
}
#sendBtn{
  width:80px;
  border-radius:999px;
  border:1px solid rgba(0,204,255,.9);
  background:radial-gradient(circle at top left,rgba(0,204,255,.9),rgba(0,0,0,.95));
  color:#e5f2ff;
  font-size:14px;
  cursor:pointer;
}

/* BARRE DU BAS */
#bottomBar{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:0;
  width:100%;
  max-width:480px;
  height:56px;
  background:linear-gradient(180deg,rgba(0,0,0,.96),rgba(0,0,0,1));
  border-top:1px solid rgba(0,153,255,.6);
  display:flex;
  align-items:center;
  justify-content:space-around;
  z-index:16;
}
.navBtn{
  flex:1;
  text-align:center;
  color:#9fb7ff;
  font-size:11px;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
}
.navIcon{
  font-size:17px;
}
.navBtn.active{
  color:#7fc4ff;
  text-shadow:0 0 8px rgba(0,153,255,.9);
}

/* MENU SUPERPOS√â (salons / contacts) */
#overlayMenu{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:40;
}
#menuBox{
  width:100%;
  max-width:480px;
  max-height:70%;
  overflow-y:auto;
  border-radius:18px 18px 0 0;
  background:radial-gradient(circle at top,rgba(0,204,255,.35),rgba(0,0,0,.98));
  border-top:1px solid rgba(0,255,255,.9);
  padding:14px;
}
.menuTitle{
  font-size:16px;
  margin-bottom:10px;
  color:#e5f2ff;
  text-align:center;
}
.menuItem{
  padding:10px 12px;
  margin-bottom:8px;
  border-radius:10px;
  border:1px solid rgba(0,153,255,.5);
  background:linear-gradient(135deg,rgba(0,102,204,.15),rgba(0,0,0,.8));
  font-size:15px;
  color:#e5f2ff;
  cursor:pointer;
  transition:.15s;
}
.menuItem:hover{
  background:linear-gradient(135deg,rgba(0,153,255,.3),rgba(0,0,0,.95));
  transform:translateY(-1px);
  box-shadow:0 0 10px rgba(0,153,255,.5);
}

/* MODAL (appui long) */
#modalOverlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:flex-end;
  justify-content:center;
  background:rgba(0,0,0,.55);
  z-index:50;
}
#modal{
  width:100%;
  max-width:480px;
  border-radius:18px 18px 0 0;
  background:radial-gradient(circle at top,rgba(0,204,255,.35),rgba(0,0,0,.98));
  border-top:1px solid rgba(0,255,255,.9);
  padding:12px 14px 10px;
}
.modalTitle{
  font-size:14px;
  margin-bottom:6px;
  color:#e5f2ff;
}
.modalActions{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.modalBtn{
  padding:9px 11px;
  border-radius:999px;
  border:1px solid rgba(0,153,255,.7);
  background:rgba(0,0,0,.9);
  color:#e5f2ff;
  font-size:14px;
  text-align:center;
  cursor:pointer;
}
.modalBtn.danger{
  border-color:rgba(255,80,80,.9);
  color:#ffd0d0;
}

/* TOAST */
#toast{
  position:fixed;
  bottom:70px;
  left:50%;
  transform:translateX(-50%);
  padding:7px 12px;
  border-radius:999px;
  background:rgba(0,0,0,.9);
  border:1px solid rgba(0,204,255,.8);
  color:#e5f2ff;
  font-size:12px;
  opacity:0;
  transition:.2s;
  z-index:60;
}
#toast.show{opacity:1}
</style>
</head>

<body>
<div id="app">

  <!-- HEADER -->
  <div id="topBar">
    <span id="appName">ThinkTalk Mobile</span>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main"></div>

  <!-- INPUT BAR -->
  <div id="inputBar">
    <input id="messageInput" placeholder="√âcris un message..." disabled>
    <button id="sendBtn" disabled>Envoyer</button>
  </div>

  <!-- BOTTOM BAR -->
  <div id="bottomBar">
    <div class="navBtn active" data-view="home">
      <span class="navIcon">üè†</span>
      <span>Home</span>
    </div>
    <div class="navBtn" data-view="rooms">
      <span class="navIcon">#</span>
      <span>Salons</span>
    </div>
    <div class="navBtn" data-view="contacts">
      <span class="navIcon">üë§</span>
      <span>Contacts</span>
    </div>
  </div>

  <!-- MENU SUPERPOS√â -->
  <div id="overlayMenu">
    <div id="menuBox">
      <div class="menuTitle">Menu</div>
      <div id="menuContent"></div>
    </div>
  </div>

  <!-- MODAL (appui long) -->
  <div id="modalOverlay">
    <div id="modal">
      <div class="modalTitle">Actions sur le message</div>
      <div class="modalActions" id="modalActions"></div>
    </div>
  </div>

  <div id="toast"></div>

</div>
<script>
// =========================
// CONFIG FIREBASE
// =========================
const firebaseConfig = {
  apiKey: "AIzaSyCrgPMXzSyS6NXNajPxr0x_J-CTESOtp5w",
  authDomain: "chat-github-6abb5.firebaseapp.com",
  databaseURL: "https://chat-github-6abb5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chat-github-6abb5",
  storageBucket: "chat-github-6abb5.firebasestorage.app",
  messagingSenderId: "1038562300660",
  appId: "1:1038562300660:web:b57b74a7539466e16384a1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// =========================
// DOM
// =========================
const main = document.getElementById("main");
const appName = document.getElementById("appName");

const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

const navBtns = document.querySelectorAll(".navBtn");

const overlayMenu = document.getElementById("overlayMenu");
const menuBox = document.getElementById("menuBox");
const menuContent = document.getElementById("menuContent");

const modalOverlay = document.getElementById("modalOverlay");
const modalActions = document.getElementById("modalActions");

const toast = document.getElementById("toast");

// =========================
// VARIABLES
// =========================
let currentUser = null;
let currentContext = null; // {type:"room"/"dm", id:"...", label:"..."}
let longPressTimer = null;

let unread = {}; // { "general": 3, "Alice": 1, ... }

// =========================
// UTILS
// =========================
function showToast(text){
  toast.textContent = text;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2000);
}

function formatTime(ts){
  const d = new Date(ts);
  return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
}

function conversationId(a,b){
  return [a,b].sort().join("__");
}

// =========================
// AUTH (simple auto-login)
// =========================
async function autoLogin(){
  const p = localStorage.getItem("ttm_pseudo");
  const c = localStorage.getItem("ttm_code");
  if(!p || !c){
    currentUser = "Invit√©"+Math.floor(Math.random()*9999);
    localStorage.setItem("ttm_pseudo",currentUser);
    localStorage.setItem("ttm_code","0000");
  } else {
    currentUser = p;
  }
  appName.textContent = "ThinkTalk Mobile ‚Äî " + currentUser;
  loadHome();
}

// =========================
// HOME = liste salons + contacts + bulles
// =========================
async function loadHome(){
  main.innerHTML = "";

  const container = document.createElement("div");

  // Salons publics
  const roomsSnap = await db.ref("publicRooms").get();
  if(roomsSnap.exists()){
    Object.keys(roomsSnap.val()).forEach(room=>{
      const div = document.createElement("div");
      div.className = "homeItem";
      div.textContent = "#"+room;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = unread[room] || 0;
      if(badge.textContent === "0") badge.style.display="none";

      div.appendChild(badge);

      div.onclick = ()=>openRoom(room);

      container.appendChild(div);
    });
  }

  // Contacts
  const contactsSnap = await db.ref("contacts/"+currentUser).get();
  if(contactsSnap.exists()){
    Object.keys(contactsSnap.val()).forEach(contact=>{
      const div = document.createElement("div");
      div.className = "homeItem";
      div.textContent = contact;

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = unread[contact] || 0;
      if(badge.textContent === "0") badge.style.display="none";

      div.appendChild(badge);

      div.onclick = ()=>openDM(contact);

      container.appendChild(div);
    });
  }

  main.appendChild(container);
}

// =========================
// OUVERTURE SALON / CONTACT
// =========================
function openRoom(room){
  currentContext = {type:"room", id:room, label:"#"+room};
  unread[room] = 0;
  appName.textContent = currentContext.label;
  loadMessages();
}

function openDM(other){
  const conv = conversationId(currentUser,other);
  currentContext = {type:"dm", id:conv, label:other, other};
  unread[other] = 0;
  appName.textContent = currentContext.label;
  loadMessages();
}

// =========================
// CHARGEMENT DES MESSAGES
// =========================
function loadMessages(){
  main.innerHTML = "";
  const messagesDiv = document.createElement("div");
  messagesDiv.id = "messages";
  main.appendChild(messagesDiv);

  let path = "";
  if(currentContext.type==="room"){
    path = "messages/public/"+currentContext.id;
  } else {
    path = "messages/dm/"+currentContext.id;
  }

  const ref = db.ref(path);
  ref.off();

  ref.on("child_added",snap=>{
    renderMessage(snap.key,snap.val());
  });

  ref.on("child_changed",snap=>{
    const el=document.getElementById("msg-"+snap.key);
    if(el){
      el.querySelector(".text").textContent = snap.val().text + (snap.val().edited?" (modifi√©)":"");
    }
  });

  ref.on("child_removed",snap=>{
    const el=document.getElementById("msg-"+snap.key);
    if(el) el.remove();
  });
}

function renderMessage(key,msg){
  const messagesDiv = document.getElementById("messages");
  if(!messagesDiv) return;

  const div=document.createElement("div");
  div.className="msg";
  div.id="msg-"+key;

  const header=document.createElement("div");
  header.className="msg-header";

  const left=document.createElement("div");
  left.innerHTML=`<span class="pseudo">${msg.pseudo}</span><span class="time">${formatTime(msg.timestamp)}</span>`;
  header.appendChild(left);

  const text=document.createElement("div");
  text.className="text";
  text.textContent=msg.text + (msg.edited?" (modifi√©)":"");

  div.appendChild(header);
  div.appendChild(text);

  // APPUI LONG
  div.addEventListener("touchstart",()=>{
    longPressTimer=setTimeout(()=>openMessageActions(key,msg),350);
  });
  div.addEventListener("touchend",()=>clearTimeout(longPressTimer));
  div.addEventListener("touchmove",()=>clearTimeout(longPressTimer));

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

// =========================
// ENVOI MESSAGE
// =========================
function getCurrentPath(){
  if(!currentContext) return null;
  if(currentContext.type==="room"){
    return "messages/public/"+currentContext.id;
  }
  return "messages/dm/"+currentContext.id;
}

function sendMessage(){
  const text = messageInput.value.trim();
  if(!text || !currentContext) return;

  const path = getCurrentPath();
  db.ref(path).push({
    pseudo:currentUser,
    text,
    timestamp:Date.now(),
    edited:false
  });

  messageInput.value="";
}

// =========================
// APPUI LONG ‚Üí MENU ACTIONS
// =========================
function openMessageActions(key,msg){
  if(msg.pseudo !== currentUser) return;

  modalActions.innerHTML="";

  const editBtn=document.createElement("div");
  editBtn.className="modalBtn";
  editBtn.textContent="Modifier";
  editBtn.onclick=()=>editMessage(key,msg);

  const delBtn=document.createElement("div");
  delBtn.className="modalBtn danger";
  delBtn.textContent="Supprimer";
  delBtn.onclick=()=>deleteMessage(key);

  const cancelBtn=document.createElement("div");
  cancelBtn.className="modalBtn";
  cancelBtn.textContent="Annuler";
  cancelBtn.onclick=()=>modalOverlay.style.display="none";

  modalActions.appendChild(editBtn);
  modalActions.appendChild(delBtn);
  modalActions.appendChild(cancelBtn);

  modalOverlay.style.display="flex";
}

function editMessage(key,msg){
  modalOverlay.style.display="none";

  const newText = prompt("Modifier :", msg.text);
  if(!newText) return;

  const path=getCurrentPath()+"/"+key;
  db.ref(path).update({text:newText,edited:true});
}

async function deleteMessage(key){
  modalOverlay.style.display="none";
  const path=getCurrentPath()+"/"+key;
  await db.ref(path).remove();
}

// =========================
// MENUS SUPERPOS√âS (salons / contacts)
// =========================
async function openRoomsMenu(){
  overlayMenu.style.display="flex";
  menuContent.innerHTML="";

  const snap = await db.ref("publicRooms").get();
  if(snap.exists()){
    Object.keys(snap.val()).forEach(room=>{
      const div=document.createElement("div");
      div.className="menuItem";
      div.textContent="#"+room;
      div.onclick=()=>{
        overlayMenu.style.display="none";
        openRoom(room);
      };
      menuContent.appendChild(div);
    });
  }
}

async function openContactsMenu(){
  overlayMenu.style.display="flex";
  menuContent.innerHTML="";

  const snap = await db.ref("contacts/"+currentUser).get();
  if(snap.exists()){
    Object.keys(snap.val()).forEach(contact=>{
      const div=document.createElement("div");
      div.className="menuItem";
      div.textContent=contact;
      div.onclick=()=>{
        overlayMenu.style.display="none";
        openDM(contact);
      };
      menuContent.appendChild(div);
    });
  }
}

overlayMenu.onclick = (e)=>{
  if(e.target===overlayMenu){
    overlayMenu.style.display="none";
  }
};

// =========================
// NAVIGATION BAS
// =========================
navBtns.forEach(btn=>{
  btn.onclick = () => {
    navBtns.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    const view = btn.dataset.view;

    if(view==="home"){
      currentContext = null;
      appName.textContent = "ThinkTalk Mobile ‚Äî " + currentUser;
      loadHome();
    }
    if(view==="rooms"){
      openRoomsMenu();
    }
    if(view==="contacts"){
      openContactsMenu();
    }
  };
});

// =========================
// CLAVIER MOBILE (WhatsApp style)
// =========================
if(window.visualViewport){
  visualViewport.addEventListener("resize",()=>{
    const offset = window.innerHeight - visualViewport.height;
    document.getElementById("inputBar").style.bottom = (56 + offset) + "px";
    main.style.paddingBottom = (offset + 20) + "px";
    main.scrollTop = main.scrollHeight;
  });
}

// =========================
// EVENTS
// =========================
sendBtn.onclick = sendMessage;
messageInput.onkeydown = e=>{if(e.key==="Enter") sendMessage()};

// =========================
// INIT
// =========================
autoLogin();
</script>
